# ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ

## ğŸ¯ ç·åˆè©•ä¾¡ï¼šâ˜…â˜…â˜…â˜…â˜…ï¼ˆ5/5ï¼‰

ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³è‡ªä½“ã®**æ§‹é€ ã¨å†…å®¹ã¯éå¸¸ã«å„ªã‚Œã¦ã„ã¾ã™**ã€‚ä»¥ä¸‹ã€é–‹ç™ºè€…ãŒè¿·ã„ã‚„ã™ã„ç®‡æ‰€ã¨æ”¹å–„ææ¡ˆã‚’ã¾ã¨ã‚ã¾ã™ã€‚

---

## âœ… å„ªã‚Œã¦ã„ã‚‹ç‚¹

### 1. **æ˜ç¢ºãªæ§‹é€ ã¨æ—©è¦‹è¡¨**
- `overview.md` ã®ã€Œã‚„ã‚ŠãŸã„ã“ã¨ â†’ å‚ç…§ã‚¬ã‚¤ãƒ‰ã€ãƒãƒƒãƒ”ãƒ³ã‚°ãŒç§€é€¸
- é–‹ç™ºè€…ãŒè¿·ã‚ãšé©åˆ‡ãªã‚¬ã‚¤ãƒ‰ã«è¾¿ã‚Šç€ã‘ã‚‹è¨­è¨ˆ

### 2. **ä¸€è²«ã—ãŸã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ€æƒ³**
- Read/Write ã®æ˜ç¢ºãªåˆ†é›¢æ–¹é‡
- Feature-first å…±ç½®ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å¾¹åº•
- ä¾å­˜æ–¹å‘ã®æ˜ç¤ºï¼ˆshared â†’ features â†’ appï¼‰

### 3. **å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰ä¾‹**
- `features.md` ã® Server Actions ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ãŒå®Ÿè·µçš„
- API ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã®çµ±ä¸€ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒæ˜ç¢º

### 4. **æ®µéšçš„ãªè©³ç´°åº¦**
- overview â†’ å„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚¬ã‚¤ãƒ‰ã¸ã®é©åˆ‡ãªæƒ…å ±ç²’åº¦
- ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã§å®Ÿè£…æ™‚ã®ç¢ºèªãƒã‚¤ãƒ³ãƒˆã‚’æä¾›

---

## ğŸ¤” åˆ†ã‹ã‚Šã«ãã„ç®‡æ‰€ãƒ»æ”¹å–„ææ¡ˆ

### 1. **ã€Œå†…éƒ¨APIã€ã®å®šç¾©ãŒæ›–æ˜§ï¼ˆapp-api.mdï¼‰**

**å•é¡Œç®‡æ‰€**: `app-api.md:4`
> **GET å°‚ç”¨**ã€‚èª­ã¿å–ã‚Šãƒ‡ãƒ¼ã‚¿ã‚’æä¾›ã™ã‚‹å†…éƒ¨ APIã€‚

**ä½•ãŒä¸æ˜ç¢ºã‹**:
- ã€Œå†…éƒ¨ã€ã¨ã¯ï¼Ÿ å¤–éƒ¨ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã®ã‹ã€ãã‚Œã¨ã‚‚èªè¨¼ãŒã‚ã‚Œã°å¤–éƒ¨ã‚‚å¯ï¼Ÿ
- å…¬é–‹ã‚·ãƒ•ãƒˆè¡¨ç¤ºï¼ˆ`/app/shifts`ï¼‰ã¯èªè¨¼ãªã—ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãŒã€ãã‚Œã‚‚ã€Œå†…éƒ¨APIã€ï¼Ÿ

**æ”¹å–„ææ¡ˆ**:
```markdown
## æ–¹é‡
- **GET å°‚ç”¨**ã€‚èª­ã¿å–ã‚Šãƒ‡ãƒ¼ã‚¿ã‚’æä¾›ã™ã‚‹ APIã€‚
- **ã€Œå†…éƒ¨ã€ã®å®šç¾©**: ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰å‘¼ã°ã‚Œã‚‹å‰æã€‚
  - èªè¨¼ãŒå¿…è¦ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ `authenticateFromRequest()` ã§ãƒã‚§ãƒƒã‚¯
  - å…¬é–‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆå…¬é–‹ã‚·ãƒ•ãƒˆè¡¨ç¤ºãªã©ï¼‰ã‚‚å«ã‚€
  - å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ã®ç›´æ¥å‘¼ã³å‡ºã—ã¯æƒ³å®šã—ãªã„ï¼ˆCORSæœªè¨­å®šï¼‰
```

---

### 2. **Server Actions ã®ã€Œå…±ç½®ã€ã®ç²’åº¦ãŒä¸æ˜ï¼ˆfeatures.mdï¼‰**

**å•é¡Œç®‡æ‰€**: `features.md:21`
> **Writeï¼ˆPOST/PUT/PATCH/DELETEï¼‰**: **Server Actions** ã‚’ `/features/<feature>/actions.ts` ã«å…±ç½®

**ä½•ãŒä¸æ˜ç¢ºã‹**:
- 1æ©Ÿèƒ½ã«è¤‡æ•°ã®Server ActionsãŒã‚ã‚‹å ´åˆã€ã™ã¹ã¦1ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`actions.ts`ï¼‰ã«æ›¸ãï¼Ÿ
- ãã‚Œã¨ã‚‚ `actions/createTodo.ts`, `actions/deleteTodo.ts` ã®ã‚ˆã†ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåˆ†å‰²ï¼Ÿ
- å‘½åè¦å‰‡ã¯ï¼Ÿ `createTodoAction` vs `createTodo`ï¼Ÿ

**æ”¹å–„ææ¡ˆ**:
```markdown
## Server Actions ã®é…ç½®ãƒ«ãƒ¼ãƒ«

### åŸºæœ¬: 1ãƒ•ã‚¡ã‚¤ãƒ«ã«é›†ç´„
```
/features/todos/
  actions.ts  # ã™ã¹ã¦ã®Writeå‡¦ç†ã‚’ã“ã“ã«ï¼ˆ3-5å€‹ç¨‹åº¦ã¾ã§ï¼‰
```

### è¤‡é›‘ãªå ´åˆ: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåˆ†å‰²
```
/features/todos/
  /actions/
    create.ts   # createTodoAction
    update.ts   # updateTodoAction
    delete.ts   # deleteTodoAction
    index.ts    # å†ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
```

### å‘½åè¦å‰‡
- é–¢æ•°å: `<å‹•è©><åè©>Action` å½¢å¼ï¼ˆä¾‹: `createTodoAction`, `updateShiftAction`ï¼‰
- ãƒ•ã‚¡ã‚¤ãƒ«å: å‹•è©ã®ã¿ï¼ˆä¾‹: `create.ts`, `update.ts`ï¼‰
```

---

### 3. **ã€ŒHydrateã€ã®èª¬æ˜ãŒãªã„ï¼ˆoverview.md, app.mdï¼‰**

**å•é¡Œç®‡æ‰€**: `overview.md:19`
> **`app/api` ã® GET** ã‚’ç”¨æ„ â†’ **RSC ã§ prefetch** â†’ CSR ã§ **`<Hydrate>`**ï¼ˆTanStack Queryï¼‰

**ä½•ãŒä¸æ˜ç¢ºã‹**:
- `<Hydrate>` ã¨ã¯ä½•ï¼Ÿ TanStack Query ã®æ¨™æº–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼Ÿ
- ã©ã“ã«é…ç½®ã™ã‚‹ã®ã‹ï¼Ÿ
- å®Ÿè£…ä¾‹ãŒãªã„

**æ”¹å–„ææ¡ˆ**:
`app.md` ã«ä»¥ä¸‹ã‚’è¿½åŠ ï¼š
```markdown
## RSC Prefetch â†’ Hydrate ãƒ‘ã‚¿ãƒ¼ãƒ³

### æ¦‚è¦
1. **RSCï¼ˆServer Componentï¼‰**: ã‚µãƒ¼ãƒãƒ¼å´ã§ãƒ‡ãƒ¼ã‚¿ã‚’ prefetch
2. **dehydrate**: prefetch ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ç›´åˆ—åŒ–
3. **Hydrate**: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ QueryClient ã«ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ

### å®Ÿè£…ä¾‹
```tsx
// app/(dashboard)/todos/page.tsx (RSC)
import { HydrationBoundary, dehydrate } from '@tanstack/react-query';
import { getQueryClient } from '@/shared/lib/queryClient';
import { prefetchTodos } from '@/features/todos/queries/prefetch';
import { TodoList } from '@/features/todos/components/TodoList';

export default async function TodosPage() {
  const queryClient = getQueryClient();
  await prefetchTodos(queryClient);

  return (
    <HydrationBoundary state={dehydrate(queryClient)}>
      <TodoList />  {/* Client Component */}
    </HydrationBoundary>
  );
}
```

```tsx
// features/todos/components/TodoList.tsx (CSC)
'use client';
import { useTodosQuery } from '../queries/useTodosQuery';

export function TodoList() {
  const { data } = useTodosQuery(); // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å³åº§ã«å–å¾—
  return <ul>{data.map(todo => <li key={todo.id}>{todo.title}</li>)}</ul>;
}
```

### æ³¨æ„ç‚¹
- `<HydrationBoundary>` ã¯ TanStack Query v5 ã®åç§°ï¼ˆv4ã§ã¯ `<Hydrate>`ï¼‰
- `getQueryClient()` ã¯ã‚µãƒ¼ãƒãƒ¼å°‚ç”¨ã®ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã‚’è¿”ã™ï¼ˆ`shared/lib/queryClient`ï¼‰
```

---

### 4. **`revalidatePath` vs `revalidateTag` ã®ä½¿ã„åˆ†ã‘ãŒä¸æ˜ï¼ˆfeatures.mdï¼‰**

**å•é¡Œç®‡æ‰€**: `features.md:37`
> æˆåŠŸå¾Œã¯ **`revalidatePath`/`revalidateTag`** ã§ RSC ã‚’æœ€æ–°åŒ–

**ä½•ãŒä¸æ˜ç¢ºã‹**:
- ã©ã¡ã‚‰ã‚’ã„ã¤ä½¿ã†ã®ã‹ï¼Ÿ
- ä¸¡æ–¹ä½¿ã†ã‚±ãƒ¼ã‚¹ã¯ï¼Ÿ

**æ”¹å–„ææ¡ˆ**:
`features.md` ã® Server Actions ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¿½åŠ ï¼š
```markdown
## revalidatePath vs revalidateTag

### revalidatePathï¼ˆæ¨å¥¨ï¼šã‚·ãƒ³ãƒ—ãƒ«ãªã‚±ãƒ¼ã‚¹ï¼‰
- **ç”¨é€”**: ç‰¹å®šã®ãƒ‘ã‚¹ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–
- **ä¾‹**: Todoä½œæˆå¾Œã« `/todos` ãƒšãƒ¼ã‚¸ã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°

```ts
export async function createTodoAction(input: unknown) {
  // ...ä½œæˆå‡¦ç†
  revalidatePath('/todos');  // /todos ãƒšãƒ¼ã‚¸ã®ã¿æ›´æ–°
}
```

### revalidateTagï¼ˆæ¨å¥¨ï¼šè¤‡é›‘ãªä¾å­˜é–¢ä¿‚ï¼‰
- **ç”¨é€”**: ã‚¿ã‚°ä»˜ã‘ã•ã‚ŒãŸè¤‡æ•°ã®fetchãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä¸€æ‹¬ç„¡åŠ¹åŒ–
- **ä¾‹**: Todoä½œæˆãŒè¤‡æ•°ãƒšãƒ¼ã‚¸ã«å½±éŸ¿ã™ã‚‹å ´åˆ

```ts
// app/api/todos/route.ts
export async function GET() {
  const data = await fetch('...', { next: { tags: ['todos'] } });
  // ...
}

// features/todos/actions.ts
export async function createTodoAction(input: unknown) {
  // ...ä½œæˆå‡¦ç†
  revalidateTag('todos');  // 'todos' ã‚¿ã‚°ã®å…¨fetchã‚’ç„¡åŠ¹åŒ–
}
```

### åˆ¤æ–­åŸºæº–
- 1-2ãƒšãƒ¼ã‚¸ã«å½±éŸ¿ â†’ `revalidatePath`
- 3+ãƒšãƒ¼ã‚¸ or è¤‡é›‘ãªä¾å­˜ â†’ `revalidateTag`
```

---

### 5. **entities ã¨ features ã®å¢ƒç•ŒãŒæ›–æ˜§ï¼ˆentities.mdï¼‰**

**å•é¡Œç®‡æ‰€**: `entities.md:11`
> æœ¬å½“ã«æ¨ªæ–­çš„ã‹ï¼Ÿï¼ˆFeature ã§é–‰ã˜ã‚‰ã‚Œãªã„ã‹è¦‹ç›´ã™ï¼‰

**ä½•ãŒä¸æ˜ç¢ºã‹**:
- ã€Œæ¨ªæ–­çš„ã€ã®å…·ä½“çš„ãªåˆ¤æ–­åŸºæº–ãŒãªã„
- ä¾‹ãŒä¸€åˆ‡ãªã„ã®ã§æƒ³åƒã—ã«ãã„

**æ”¹å–„ææ¡ˆ**:
```markdown
## entities vs features ã®åˆ¤æ–­ãƒ•ãƒ­ãƒ¼

```mermaid
graph TD
    A[æ–°ã—ã„ãƒ‰ãƒ¡ã‚¤ãƒ³æ¦‚å¿µ] --> B{3ã¤ä»¥ä¸Šã®Featureã‹ã‚‰å‚ç…§ã•ã‚Œã‚‹?}
    B -->|No| C[Feature å†…ã«é…ç½®]
    B -->|Yes| D{ç‹¬è‡ªã®CRUD APIã‚’æŒã¤?}
    D -->|Yes| E[ç‹¬ç«‹ã—ãŸFeatureã¨ã—ã¦é…ç½®]
    D -->|No| F{ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ãŒè¤‡é›‘?}
    F -->|Yes| E
    F -->|No| G[entities ã«é…ç½®]
```

## é…ç½®ä¾‹

### âœ… entities ã«é…ç½®ã™ã¹ãã‚‚ã®
- **User**: èªè¨¼ã€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã€ã‚³ãƒ¡ãƒ³ãƒˆã€å±¥æ­´ã§å‚ç…§ã€‚ç‹¬è‡ªã®CRUD APIã¯ãªã„ï¼ˆauth featureã§ç®¡ç†ï¼‰
- **Tag**: è¤‡æ•°ã®æ©Ÿèƒ½ã§ä½¿ç”¨ã€‚å˜ç´”ãªå‹å®šç¾©ã¨å°UIã®ã¿

### âŒ features ã«é…ç½®ã™ã¹ãã‚‚ã®
- **Instructor**: ã‚¤ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ç®¡ç†æ©Ÿèƒ½ã§ç‹¬è‡ªã®CRUDã€‚ä»–æ©Ÿèƒ½ã‹ã‚‰ã‚‚å‚ç…§ã•ã‚Œã‚‹ãŒã€ä¸­å¿ƒçš„ãªãƒ‰ãƒ¡ã‚¤ãƒ³
- **Shift**: ã‚·ãƒ•ãƒˆç®¡ç†ã®ä¸­æ ¸ã€‚è¤‡é›‘ãªãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯

### åˆ¤æ–­ã«è¿·ã£ãŸã‚‰
â†’ ã¾ãš **features** ã«é…ç½®ã€‚3ã¤ç›®ã®å‚ç…§ç®‡æ‰€ãŒå‡ºãŸã‚‰ entities ã¸æ˜‡æ ¼ã‚’æ¤œè¨
```

---

### 6. **widgets ã®ã€ŒI/Oã¯æŒãŸãªã„ã€ã®è§£é‡ˆãŒæ›–æ˜§ï¼ˆwidgets.mdï¼‰**

**å•é¡Œç®‡æ‰€**: `widgets.md:7`
> I/O ã¯æŒãŸãšã€ä¸Šä½ï¼ˆapp/pages ã‚„ features/pagesï¼‰ã«å§”è­²ã€‚

**ä½•ãŒä¸æ˜ç¢ºã‹**:
- ã€ŒI/Oã€ã¨ã¯ï¼Ÿ ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒãƒ³ã‚°å…¨èˆ¬ï¼Ÿ ãã‚Œã¨ã‚‚ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚‚ï¼Ÿ
- onClick ãƒãƒ³ãƒ‰ãƒ©ã¯ Widget ã«æŒãŸã›ã¦ã„ã„ï¼Ÿ

**æ”¹å–„ææ¡ˆ**:
```markdown
## I/O åˆ¶é™ã®è©³ç´°

### âŒ Widget ã§ç¦æ­¢
- ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒãƒ³ã‚°ï¼ˆ`useQuery`, `useMutation`, `fetch`ï¼‰
- Server Actions ã®ç›´æ¥å‘¼ã³å‡ºã—
- ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ã®æ›´æ–°ï¼ˆcontext ã¸ã®æ›¸ãè¾¼ã¿ï¼‰

### âœ… Widget ã§è¨±å¯
- PropsçµŒç”±ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ï¼ˆ`onClick`, `onSubmit` ãªã©ï¼‰
- ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ï¼ˆ`useState` ã§ã®é–‹é–‰åˆ¶å¾¡ãªã©ï¼‰
- ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ã®**èª­ã¿å–ã‚Š**ã®ã¿ï¼ˆcontext ã®å‚ç…§ï¼‰

### å®Ÿè£…ä¾‹

```tsx
// âŒ æ‚ªã„ä¾‹: Widget ãŒãƒ‡ãƒ¼ã‚¿å–å¾—
export function DashboardCard() {
  const { data } = useShiftsQuery(); // Widget ã§ãƒ‡ãƒ¼ã‚¿å–å¾—ã¯ç¦æ­¢
  return <Card>{data.length} shifts</Card>;
}

// âœ… è‰¯ã„ä¾‹: ãƒ‡ãƒ¼ã‚¿ã¯ Props ã§å—ã‘å–ã‚‹
export function DashboardCard({ shiftCount }: { shiftCount: number }) {
  return <Card>{shiftCount} shifts</Card>;
}

// å‘¼ã³å‡ºã—å´ï¼ˆapp/page.tsx ã¾ãŸã¯ features/pagesï¼‰ã§ãƒ‡ãƒ¼ã‚¿å–å¾—
export default function DashboardPage() {
  const { data } = useShiftsQuery();
  return <DashboardCard shiftCount={data.length} />;
}
```
```

---

### 7. **test.md ã®ã€ŒFeature è¿‘æ¥ã€ã®å…·ä½“çš„ãªé…ç½®å ´æ‰€ãŒä¸æ˜**

**å•é¡Œç®‡æ‰€**: `test.md:8`
> `__tests__` ã¯ **Feature è¿‘æ¥**ã€/test ã¯**åŸºç›¤**ã€‚

**ä½•ãŒä¸æ˜ç¢ºã‹**:
- ã€Œè¿‘æ¥ã€ã¨ã¯ Feature ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ç›´ä¸‹ï¼Ÿ ãã‚Œã¨ã‚‚ components ã®éš£ï¼Ÿ
- ãƒ•ã‚¡ã‚¤ãƒ«åã®å‘½åè¦å‰‡ã¯ï¼Ÿ

**æ”¹å–„ææ¡ˆ**:
```markdown
## ãƒ†ã‚¹ãƒˆé…ç½®ãƒ«ãƒ¼ãƒ«

### Unit/Integration ãƒ†ã‚¹ãƒˆ
- **é…ç½®å ´æ‰€**: ãƒ†ã‚¹ãƒˆå¯¾è±¡ã¨åŒéšå±¤ã® `__tests__` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
- **å‘½åè¦å‰‡**: `<å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«å>.test.ts(x)`

```
/features/todos/
  /components/
    TodoList.tsx
    __tests__/
      TodoList.test.tsx       # TodoList ã®ãƒ†ã‚¹ãƒˆ
  /queries/
    useTodosQuery.ts
    __tests__/
      useTodosQuery.test.ts   # Query ã®ãƒ†ã‚¹ãƒˆ
  /actions.ts
  __tests__/
    actions.test.ts           # Server Actions ã®ãƒ†ã‚¹ãƒˆï¼ˆMSWã§ãƒ¢ãƒƒã‚¯ï¼‰
```

### E2Eãƒ†ã‚¹ãƒˆ
- **é…ç½®å ´æ‰€**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã® `/e2e` ã¾ãŸã¯ `/tests/e2e`
- **å‘½åè¦å‰‡**: `<ãƒ•ãƒ­ãƒ¼å>.spec.ts`

```
/e2e/
  auth.spec.ts      # èªè¨¼ãƒ•ãƒ­ãƒ¼
  shift-crud.spec.ts  # ã‚·ãƒ•ãƒˆCRUD
```

### Storybook
- **é…ç½®å ´æ‰€**: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨åŒéšå±¤
- **å‘½åè¦å‰‡**: `<ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå>.stories.tsx`

```
/features/todos/components/
  TodoList.tsx
  TodoList.stories.tsx
```
```

---

### 8. **overview.md ã®ã€Œãƒ‡ãƒ¼ã‚¿å–å¾—ã®æ„æ€æ±ºå®šã€ã«ä¾‹å¤–ã‚±ãƒ¼ã‚¹ã®èª¬æ˜ä¸è¶³**

**å•é¡Œç®‡æ‰€**: `overview.md:22`
> 4) **URLã§å—ã‘ã‚‹å¿…è¦ãŒã‚ã‚‹ã‚‚ã®ï¼ˆWebhook/OAuth callback ç­‰ï¼‰** â†’ ä¾‹å¤–çš„ã« **`app/api`** ã‚’ä½¿ç”¨ã€‚

**ä½•ãŒä¸æ˜ç¢ºã‹**:
- ã“ã®ä¾‹å¤–ã‚±ãƒ¼ã‚¹ã§ã‚‚ GET å°‚ç”¨ãªã®ã‹ã€POST ã‚‚è¨±å¯ã•ã‚Œã‚‹ã®ã‹ï¼Ÿ
- Webhook ã¯ POST ãŒä¸€èˆ¬çš„ã ãŒã€ãã‚Œã¯è¨±å¯ã•ã‚Œã‚‹ï¼Ÿ

**æ”¹å–„ææ¡ˆ**:
```markdown
## ãƒ‡ãƒ¼ã‚¿å–å¾—ã®æ„æ€æ±ºå®šï¼ˆè¶…è¦ç´„ï¼‰
1) **èª­ã¿å–ã‚Šï¼ˆGETï¼‰** â†’ **`app/api` ã® GET** ã‚’ç”¨æ„ â†’ **RSC ã§ prefetch** â†’ CSR ã§ **`<Hydrate>`**ï¼ˆTanStack Queryï¼‰ã€‚
2) **æ›´æ–°ï¼ˆPOST/PUT/PATCH/DELETEï¼‰** â†’ **Server Actions** ã‚’å®Ÿè£…ï¼ˆzod æ¤œè¨¼ + `revalidatePath`/`revalidateTag`ï¼‰ã€‚
3) **é »ç¹æ›´æ–°/ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ** â†’ **CSR + Query**ï¼ˆ`refetchInterval` / WS ãªã©ï¼‰ã€‚
4) **å¤–éƒ¨ã‹ã‚‰URLã§å‘¼ã°ã‚Œã‚‹ã‚‚ã®ï¼ˆä¾‹å¤–ï¼‰** â†’ **`app/api` ã« POST/PUT ç­‰ã‚’å®Ÿè£…**ã€‚

### ä¾‹å¤–ã‚±ãƒ¼ã‚¹ï¼ˆå¤–éƒ¨URLå¿…é ˆï¼‰ã®è©³ç´°
ä»¥ä¸‹ã®ã‚±ãƒ¼ã‚¹ã¯å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ãŒURLã‚’å‘¼ã³å‡ºã™ãŸã‚ã€API Route ãŒå¿…é ˆã§ã™ï¼š

| ã‚±ãƒ¼ã‚¹ | ãƒ¡ã‚½ãƒƒãƒ‰ | é…ç½®ä¾‹ | å‚™è€ƒ |
|--------|----------|--------|------|
| Webhook | POST | `/app/api/webhooks/stripe/route.ts` | å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ |
| OAuth callback | GET/POST | `/app/api/auth/line/callback/route.ts` | èªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‹ã‚‰ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ |
| å¤–éƒ¨APIå…¬é–‹ | GET/POST | `/app/api/public/stats/route.ts` | å¤–éƒ¨é€£æºç”¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ |

**åŸå‰‡**: ã“ã‚Œã‚‰ã®ä¾‹å¤–ä»¥å¤–ã¯ Server Actions ã‚’ä½¿ç”¨
```

---

### 9. **ã€ŒqueryKey ã®é›†ä¸­ç®¡ç†ã€ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒä¸æ˜ç¢ºï¼ˆfeatures.mdï¼‰**

**å•é¡Œç®‡æ‰€**: `features.md:23`
> `keys.ts` ã« `queryKey` ã‚’é›†ä¸­ï¼ˆ`as const`ï¼‰ã€‚

**ä½•ãŒä¸æ˜ç¢ºã‹**:
- éšå±¤çš„ãªã‚­ãƒ¼è¨­è¨ˆã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒç¤ºã•ã‚Œã¦ã„ãªã„
- ãƒ•ã‚£ãƒ«ã‚¿ãŒã‚ã‚‹å ´åˆã®è¨­è¨ˆä¾‹ãŒãªã„

**æ”¹å–„ææ¡ˆ**:
```markdown
## queryKey ã®è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³

### åŸºæœ¬æ§‹é€ 
TanStack Query ã®å…¬å¼æ¨å¥¨ã«å¾“ã„ã€éšå±¤çš„ã«è¨­è¨ˆã—ã¾ã™ã€‚

```ts
// features/todos/queries/keys.ts
export const todoKeys = {
  all: ['todos'] as const,                              // ['todos']
  lists: () => [...todoKeys.all, 'list'] as const,      // ['todos', 'list']
  list: (filters: string) => [...todoKeys.lists(), { filters }] as const, // ['todos', 'list', { filters }]
  details: () => [...todoKeys.all, 'detail'] as const,  // ['todos', 'detail']
  detail: (id: number) => [...todoKeys.details(), id] as const, // ['todos', 'detail', 1]
};
```

### ç„¡åŠ¹åŒ–ã®ç²’åº¦
```ts
// ã™ã¹ã¦ã® todos é–¢é€£ã‚’ç„¡åŠ¹åŒ–
queryClient.invalidateQueries({ queryKey: todoKeys.all });

// ãƒªã‚¹ãƒˆã®ã¿ç„¡åŠ¹åŒ–ï¼ˆè©³ç´°ã¯æ®‹ã‚‹ï¼‰
queryClient.invalidateQueries({ queryKey: todoKeys.lists() });

// ç‰¹å®šãƒ•ã‚£ãƒ«ã‚¿ã®ãƒªã‚¹ãƒˆã®ã¿ç„¡åŠ¹åŒ–
queryClient.invalidateQueries({ queryKey: todoKeys.list('active') });
```

### è¤‡æ•°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ
```ts
export const shiftKeys = {
  all: ['shifts'] as const,
  lists: () => [...shiftKeys.all, 'list'] as const,
  list: (params: { departmentId?: number; dateFrom?: string; dateTo?: string }) =>
    [...shiftKeys.lists(), params] as const,
};
```
```

---

### 10. **ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³ã®èª¬æ˜ãŒæ¦‚è¦ã®ã¿ï¼ˆoverview.md:81ï¼‰**

**å•é¡Œç®‡æ‰€**: `overview.md:81`
> ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³: UI ã‹ã‚‰ã®ç›´ `fetch`ã€`queryKey` ç›´æ›¸ãã€å¢ƒç•Œé•åã€Story/Tests ã®åˆ†é›¢ã€‚

**ä½•ãŒä¸æ˜ç¢ºã‹**:
- ãªãœã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³ãªã®ã‹ç†ç”±ãŒãªã„
- ã€Œå¢ƒç•Œé•åã€ãŒä½•ã‚’æŒ‡ã™ã®ã‹ä¸æ˜

**æ”¹å–„ææ¡ˆ**:
æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ« `docs/guideline/anti-patterns.md` ã‚’ä½œæˆï¼š

```markdown
# ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³é›†

## 1. âŒ UI ã‹ã‚‰ç›´æ¥ fetch
```tsx
// æ‚ªã„ä¾‹
export function TodoList() {
  const [todos, setTodos] = useState([]);
  useEffect(() => {
    fetch('/api/todos').then(r => r.json()).then(setTodos);
  }, []);
  return <ul>{todos.map(...)}</ul>;
}
```

**å•é¡Œç‚¹**:
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒåŠ¹ã‹ãªã„ï¼ˆæ¯å›é€šä¿¡ï¼‰
- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ»ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã®ç®¡ç†ãŒç…©é›‘
- å‹å®‰å…¨æ€§ãŒãªã„

**æ­£ã—ã„å®Ÿè£…**: TanStack Query çµŒç”±
```tsx
export function TodoList() {
  const { data, isLoading, error } = useTodosQuery();
  if (isLoading) return <Loading />;
  if (error) return <Error />;
  return <ul>{data.map(...)}</ul>;
}
```

## 2. âŒ queryKey ã®ç›´æ›¸ã
```tsx
// æ‚ªã„ä¾‹
useQuery({ queryKey: ['todos', 'list'], queryFn: fetchTodos });
```

**å•é¡Œç‚¹**:
- typo ã®ãƒªã‚¹ã‚¯
- ç„¡åŠ¹åŒ–æ™‚ã«ã‚­ãƒ¼ã®ä¸ä¸€è‡´ã§ãƒã‚°

**æ­£ã—ã„å®Ÿè£…**: keys.ts ã§é›†ä¸­ç®¡ç†
```tsx
useQuery({ queryKey: todoKeys.list(), queryFn: fetchTodos });
```

## 3. âŒ å¢ƒç•Œé•åï¼ˆä¾å­˜ã®é€†æµï¼‰
```tsx
// æ‚ªã„ä¾‹: shared ãŒ features ã«ä¾å­˜
// shared/components/Header.tsx
import { useAuth } from '@/features/auth/queries'; // NG!
```

**å•é¡Œç‚¹**:
- å¾ªç’°ä¾å­˜ã®ãƒªã‚¹ã‚¯
- shared ã®å†åˆ©ç”¨æ€§ãŒæãªã‚ã‚Œã‚‹

**ä¾å­˜æ–¹å‘**: `app â†’ features â†’ entities â†’ shared â†’ ãƒ©ã‚¤ãƒ–ãƒ©ãƒª`

## 4. âŒ Story/Tests ã‚’ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰åˆ†é›¢
```
// æ‚ªã„ä¾‹
/features/todos/components/
  TodoList.tsx
/features/todos/stories/
  TodoList.stories.tsx    # é›¢ã‚Œã¦ã„ã‚‹
/__tests__/features/todos/
  TodoList.test.tsx       # é›¢ã‚Œã¦ã„ã‚‹
```

**å•é¡Œç‚¹**:
- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆç§»å‹•æ™‚ã« Story/Tests ã‚’å¿˜ã‚Œã‚‹
- ãƒ•ã‚¡ã‚¤ãƒ«é–“ã®ç§»å‹•ãŒé¢å€’

**æ­£ã—ã„é…ç½®**: ã‚³ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆè¿‘æ¥é…ç½®ï¼‰
```
/features/todos/components/
  TodoList.tsx
  TodoList.stories.tsx    # åŒéšå±¤
  __tests__/
    TodoList.test.tsx     # è¿‘æ¥
```
```

---

## ğŸ“‹ å„ªå…ˆåº¦åˆ¥æ”¹å–„ãƒªã‚¹ãƒˆ

### ğŸ”´ å„ªå…ˆåº¦ï¼šé«˜ï¼ˆé–‹ç™ºè€…ãŒé »ç¹ã«è¿·ã†ç®‡æ‰€ï¼‰
1. âœ… Server Actions ã®é…ç½®ãƒ»å‘½åè¦å‰‡ï¼ˆfeatures.mdï¼‰
2. âœ… `<Hydrate>` ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè£…ä¾‹ï¼ˆapp.mdï¼‰
3. âœ… `revalidatePath` vs `revalidateTag`ï¼ˆfeatures.mdï¼‰
4. âœ… entities vs features ã®åˆ¤æ–­åŸºæº–ï¼ˆentities.mdï¼‰

### ğŸŸ¡ å„ªå…ˆåº¦ï¼šä¸­ï¼ˆæ˜ç¢ºåŒ–ã™ã‚‹ã¨ä¾¿åˆ©ï¼‰
5. âœ… widgets ã® I/O åˆ¶é™ã®è©³ç´°ï¼ˆwidgets.mdï¼‰
6. âœ… ãƒ†ã‚¹ãƒˆé…ç½®ãƒ«ãƒ¼ãƒ«ï¼ˆtest.mdï¼‰
7. âœ… queryKey è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆfeatures.mdï¼‰
8. âœ… ä¾‹å¤–ã‚±ãƒ¼ã‚¹ï¼ˆWebhookç­‰ï¼‰ã®èª¬æ˜ï¼ˆoverview.mdï¼‰

### ğŸŸ¢ å„ªå…ˆåº¦ï¼šä½ï¼ˆã‚ã‚‹ã¨å®Œç’§ï¼‰
9. âœ… ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³é›†ã®ç‹¬ç«‹åŒ–
10. âœ… ã€Œå†…éƒ¨APIã€ã®å®šç¾©æ˜ç¢ºåŒ–ï¼ˆapp-api.mdï¼‰

---

## âœ¨ çµè«–

ç¾çŠ¶ã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã¯**éª¨æ ¼ã¯éå¸¸ã«å„ªç§€**ã§ã™ã€‚ä¸Šè¨˜ã®å…·ä½“ä¾‹ãƒ»åˆ¤æ–­åŸºæº–ã‚’è£œå¼·ã™ã‚‹ã“ã¨ã§ã€**é–‹ç™ºè€…ãŒè¿·ã‚ãšå®Ÿè£…ã§ãã‚‹å®Œç’§ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**ã«ãªã‚Šã¾ã™ã€‚

ç‰¹ã«å„ªå…ˆåº¦ï¼šé«˜ï¼ˆ1-4ï¼‰ã®æ”¹å–„ã‚’å®Ÿæ–½ã™ã‚‹ã“ã¨ã§ã€ä»¥ä¸‹ã®åŠ¹æœãŒæœŸå¾…ã§ãã¾ã™ï¼š

1. **å®Ÿè£…ã®ä¸€è²«æ€§å‘ä¸Š**: é–‹ç™ºè€…é–“ã§ã®å®Ÿè£…æ–¹æ³•ã®ã°ã‚‰ã¤ãã‚’æœ€å°åŒ–
2. **ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ™‚é–“çŸ­ç¸®**: æ–°è¦å‚åŠ è€…ãŒè¿·ã‚ãšå®Ÿè£…ã‚’é–‹å§‹ã§ãã‚‹
3. **ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ã‚¹ãƒˆå‰Šæ¸›**: ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³æº–æ‹ ã®ç¢ºèªãŒå®¹æ˜“ã«ãªã‚‹
4. **ä¿å®ˆæ€§å‘ä¸Š**: Feature-first + Server Actions ã«ã‚ˆã‚Šå¤‰æ›´ã®å½±éŸ¿ç¯„å›²ãŒå±€æ‰€åŒ–ã•ã‚Œã‚‹

Feature-first + Server Actions ã®æ–¹é‡ã¯ã€Next.js App Router ã® best practice ã«åˆè‡´ã—ã¦ãŠã‚Šã€é•·æœŸçš„ãªä¿å®ˆæ€§ã‚’å¤§ããå‘ä¸Šã•ã›ã‚‹ã§ã—ã‚‡ã†ã€‚
